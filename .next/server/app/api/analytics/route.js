"use strict";(()=>{var e={};e.id=1567,e.ids=[1567],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},32724:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>h,patchFetch:()=>v,requestAsyncStorage:()=>m,routeModule:()=>p,serverHooks:()=>y,staticGenerationAsyncStorage:()=>g});var a={};r.r(a),r.d(a,{GET:()=>d});var s=r(49303),n=r(88716),o=r(60670),i=r(87070),l=r(75571),u=r(20728),c=r(95456);async function d(e){try{let t=await (0,l.getServerSession)(c.L),r=t?.user?.role;if(!t||"ADMIN"!==r)return i.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:a}=new URL(e.url),s=a.get("period")||"30d",n=a.get("metric")||"overview",o=new Date,d=new Date;switch(s){case"7d":d.setDate(o.getDate()-7);break;case"30d":d.setDate(o.getDate()-30);break;case"90d":d.setDate(o.getDate()-90);break;case"1y":d.setFullYear(o.getFullYear()-1)}if("overview"===n){let e=await u._.order.findMany({where:{createdAt:{gte:d},status:{not:"CANCELLED"}},select:{total:!0,createdAt:!0,type:!0}}),t=e.reduce((e,t)=>{let r=t.createdAt.toISOString().split("T")[0];return e[r]||(e[r]={total:0,count:0}),e[r].total+=t.total,e[r].count+=1,e},{}),r=e.reduce((e,t)=>(e[t.type]||(e[t.type]={total:0,count:0}),e[t.type].total+=t.total,e[t.type].count+=1,e),{}),a=await u._.user.findMany({where:{role:"CLIENT",createdAt:{gte:d}}}),n=a.reduce((e,t)=>{let r=t.createdAt.toISOString().split("T")[0];return e[r]||(e[r]=0),e[r]+=1,e},{}),o=await u._.repair.findMany({where:{createdAt:{gte:d}},select:{status:!0,createdAt:!0,isEasyMailIn:!0,finalCost:!0}}),l=o.reduce((e,t)=>(e[t.status]||(e[t.status]=0),e[t.status]+=1,e),{}),c=o.filter(e=>e.isEasyMailIn).length,p=o.reduce((e,t)=>e+(t.finalCost||0),0),m=[{name:"PC Configurator",revenue:r.PC_BUILD?.total||0,orders:r.PC_BUILD?.count||0},{name:"PS5 Controller",revenue:r.PS5_CONTROLLER?.total||0,orders:r.PS5_CONTROLLER?.count||0},{name:"Products",revenue:r.PRODUCT?.total||0,orders:r.PRODUCT?.count||0},{name:"Gift Cards",revenue:r.GIFT_CARD?.total||0,orders:r.GIFT_CARD?.count||0},{name:"Repairs",revenue:p,orders:o.length}].sort((e,t)=>t.revenue-e.revenue);return i.NextResponse.json({overview:{totalRevenue:e.reduce((e,t)=>e+t.total,0),totalOrders:e.length,totalCustomers:a.length,totalRepairs:o.length,avgOrderValue:e.length>0?e.reduce((e,t)=>e+t.total,0)/e.length:0,easyMailInPercentage:o.length>0?c/o.length*100:0},charts:{revenueByDate:Object.entries(t).map(([e,t])=>({date:e,revenue:t.total,orders:t.count})),revenueByType:Object.entries(r).map(([t,r])=>({type:t,revenue:r.total,orders:r.count,percentage:(r.total/e.reduce((e,t)=>e+t.total,0)*100).toFixed(1)})),customersByDate:Object.entries(n).map(([e,t])=>({date:e,customers:t})),repairsByStatus:Object.entries(l).map(([e,t])=>({status:e,count:t,percentage:(t/o.length*100).toFixed(1)}))},topServices:m,period:s})}if("sales"===n){let e=await u._.order.findMany({where:{createdAt:{gte:d}},include:{user:{select:{name:!0,email:!0}},orderItems:{include:{product:{select:{name:!0,category:!0}}}}}});return i.NextResponse.json({sales:e.map(e=>({id:e.id,orderNumber:e.orderNumber,customer:e.user.name,total:e.total,status:e.status,type:e.type,createdAt:e.createdAt,itemCount:e.orderItems.length})),summary:{totalSales:e.reduce((e,t)=>e+t.total,0),orderCount:e.length,avgOrderValue:e.length>0?e.reduce((e,t)=>e+t.total,0)/e.length:0}})}return i.NextResponse.json({error:"Invalid metric"},{status:400})}catch(e){return console.error("Analytics API error:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}}let p=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/analytics/route",pathname:"/api/analytics",filename:"route",bundlePath:"app/api/analytics/route"},resolvedPagePath:"/workspace/src/app/api/analytics/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:m,staticGenerationAsyncStorage:g,serverHooks:y}=p,h="/api/analytics/route";function v(){return(0,o.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:g})}},95456:(e,t,r)=>{r.d(t,{L:()=>i});var a=r(53797),s=r(42023),n=r.n(s),o=r(20728);let i={providers:[(0,a.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;try{let t=await o._.user.findUnique({where:{email:e.email}});if(!t||!t.isActive||!await n().compare(e.password,t.password))return null;return{id:t.id,email:t.email,name:t.name,role:t.role}}catch(e){return console.error("Auth error:",e),null}}})],session:{strategy:"jwt",maxAge:2592e3},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.role=t?.role),e),session:async({session:e,token:t})=>(t&&(e.user.id=t.sub,e.user.role=t.role),e)},pages:{signIn:"/auth/login",signUp:"/auth/register"},secret:process.env.NEXTAUTH_SECRET}},20728:(e,t,r)=>{r.d(t,{_:()=>s});let a=require("@prisma/client"),s=global.prisma||new a.PrismaClient({log:["query"]})}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[9276,5972,2023,1790],()=>r(32724));module.exports=a})();