"use strict";(()=>{var e={};e.id=6553,e.ids=[6553],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},4519:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>x,patchFetch:()=>h,requestAsyncStorage:()=>m,routeModule:()=>p,serverHooks:()=>g,staticGenerationAsyncStorage:()=>w});var a={};r.r(a),r.d(a,{GET:()=>c});var s=r(49303),o=r(88716),i=r(60670),n=r(87070),u=r(75571),l=r(20728),d=r(95456);async function c(e){try{let t=await (0,u.getServerSession)(d.L),r=t?.user?.role;if(!t||"ADMIN"!==r)return n.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:a}=new URL(e.url),s=a.get("period")||"30d",o=new Date,i=new Date;switch(s){case"7d":i.setDate(o.getDate()-7);break;case"30d":i.setDate(o.getDate()-30);break;case"90d":i.setDate(o.getDate()-90);break;case"1y":i.setFullYear(o.getFullYear()-1)}let c=await l._.order.findMany({where:{createdAt:{gte:i},status:{not:"CANCELLED"}},select:{total:!0,createdAt:!0,status:!0}}),p=c.reduce((e,t)=>e+t.total,0),m=c.filter(e=>e.createdAt.toDateString()===o.toDateString()).reduce((e,t)=>e+t.total,0),w=new Date(i);w.setDate(w.getDate()-(o.getTime()-i.getTime())/864e5);let g=(await l._.order.findMany({where:{createdAt:{gte:w,lt:i},status:{not:"CANCELLED"}},select:{total:!0}})).reduce((e,t)=>e+t.total,0),[x,h,E,y,N]=await Promise.all([l._.order.count(),l._.order.count({where:{status:"PENDING"}}),l._.order.count({where:{status:"PROCESSING"}}),l._.order.count({where:{status:"DELIVERED"}}),l._.order.count({where:{status:"CANCELLED"}})]),[A,D,I,b]=await Promise.all([l._.repair.count(),l._.repair.count({where:{status:{in:["PENDING","RECEIVED","DIAGNOSING","REPAIRING"]}}}),l._.repair.count({where:{status:"COMPLETED"}}),l._.repair.count({where:{isEasyMailIn:!0}})]),[v,_,q]=await Promise.all([l._.user.count({where:{role:"CLIENT"}}),l._.user.count({where:{role:"CLIENT",createdAt:{gte:i}}}),l._.user.count({where:{role:"CLIENT",orders:{some:{createdAt:{gte:i}}}}})]),P=await l._.order.findMany({take:5,orderBy:{createdAt:"desc"},include:{user:{select:{name:!0,email:!0}}}}),R=await l._.repair.findMany({take:5,where:{status:{in:["PENDING","RECEIVED","DIAGNOSING","REPAIRING"]}},orderBy:{createdAt:"desc"},include:{user:{select:{name:!0,email:!0}}}}),f=[{id:"1",type:"low_stock",message:`8 produkte kan\xeb stok t\xeb ul\xebt`,time:"5 minuta m\xeb par\xeb"},{id:"2",type:"new_order",message:`Porosi e re ${P[0]?.orderNumber||"#PB-2024-XXX"}`,time:"15 minuta m\xeb par\xeb"},{id:"3",type:"repair_update",message:`Riparim ${R[0]?.repairNumber||"PR-2024-XXX"} p\xebrdit\xebsuar`,time:"1 or\xeb m\xeb par\xeb"}];return n.NextResponse.json({stats:{revenue:{today:m,thisMonth:p,lastMonth:g,growth:g>0?(p-g)/g*100:0},orders:{total:x,pending:h,processing:E,completed:y,cancelled:N},repairs:{total:A,active:D,completed:I,easyMailIn:b},customers:{total:v,new:_,active:q},inventory:{lowStock:8,outOfStock:3}},recentOrders:P.map(e=>({id:e.id,orderNumber:e.orderNumber,customer:e.user.name,total:e.total,status:e.status,createdAt:e.createdAt})),activeRepairs:R.map(e=>({id:e.id,repairNumber:e.repairNumber,customer:e.user.name,device:e.deviceType,status:e.status,isEasyMailIn:e.isEasyMailIn,createdAt:e.createdAt})),notifications:f})}catch(e){return console.error("Get admin stats error:",e),n.NextResponse.json({error:"Internal server error"},{status:500})}}let p=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/admin/stats/route",pathname:"/api/admin/stats",filename:"route",bundlePath:"app/api/admin/stats/route"},resolvedPagePath:"/workspace/src/app/api/admin/stats/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:m,staticGenerationAsyncStorage:w,serverHooks:g}=p,x="/api/admin/stats/route";function h(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:w})}},95456:(e,t,r)=>{r.d(t,{L:()=>n});var a=r(53797),s=r(42023),o=r.n(s),i=r(20728);let n={providers:[(0,a.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;try{let t=await i._.user.findUnique({where:{email:e.email}});if(!t||!t.isActive||!await o().compare(e.password,t.password))return null;return{id:t.id,email:t.email,name:t.name,role:t.role}}catch(e){return console.error("Auth error:",e),null}}})],session:{strategy:"jwt",maxAge:2592e3},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.role=t?.role),e),session:async({session:e,token:t})=>(t&&(e.user.id=t.sub,e.user.role=t.role),e)},pages:{signIn:"/auth/login"},secret:process.env.NEXTAUTH_SECRET}},20728:(e,t,r)=>{r.d(t,{_:()=>s});let a=require("@prisma/client"),s=global.prisma||new a.PrismaClient({log:["query"]})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[9276,5972,2023,1790],()=>r(4519));module.exports=a})();